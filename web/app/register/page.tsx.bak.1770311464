"use client";

import { useState } from "react";
import { useRouter } from "next/navigation";

export default function RegisterPage() {
  const router = useRouter();
  const [portal, setPortal] = useState<"USER" | "UNIVERSITY">("USER");
  const [email, setEmail] = useState("");
  const [password, setPassword] = useState("");
  const [universitySlug, setUniversitySlug] = useState("");

  async function submit(e: React.FormEvent) {
    e.preventDefault();

    const API_BASE = process.env.NEXT_PUBLIC_API_BASE_URL || "";
    if (!API_BASE) {
      alert("Missing NEXT_PUBLIC_API_BASE_URL (web/.env.local)");
      return;
    }

    const body: any = { email, password, role: portal };
    if (portal === "UNIVERSITY") body.universitySlug = universitySlug;

    const res = await fetch(`${API_BASE}/api/v1/auth/register`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(body),
    });

    const text = await res.text();
    let msg = text;
    try {
      const j = JSON.parse(text);
      msg = j?.message || j?.error || JSON.stringify(j);
    } catch {}

    if (!res.ok) {
      alert(`Registration failed (${res.status})\n${msg}`);
      return;
    }

    // succès -> go login
    router.push("/login");
  }

  return (
    <div className="mx-auto mt-32 max-w-md rounded-xl border p-8">
      <h1 className="text-xl font-semibold mb-2">Create account</h1>
      <p className="text-sm text-gray-500 mb-6">Choose your portal</p>

      <div className="flex gap-2 mb-6">
        <button
          type="button"
          className={`flex-1 rounded-md border px-4 py-2 ${
            portal === "USER" ? "bg-black text-white" : ""
          }`}
          onClick={() => setPortal("USER")}
        >
          Étudiant
        </button>
        <button
          type="button"
          className={`flex-1 rounded-md border px-4 py-2 ${
            portal === "UNIVERSITY" ? "bg-black text-white" : ""
          }`}
          onClick={() => setPortal("UNIVERSITY")}
        >
          Université
        </button>
      </div>

      <form onSubmit={submit} className="space-y-4">
        <input
          className="w-full rounded-md border px-3 py-2"
          placeholder="Email (ex: test@school.com)"
          value={email}
          onChange={(e) => setEmail(e.target.value)}
          required
        />

        <input
          className="w-full rounded-md border px-3 py-2"
          type="password"
          placeholder="Password"
          value={password}
          onChange={(e) => setPassword(e.target.value)}
          required
        />

        {portal === "UNIVERSITY" && (
          <input
            className="w-full rounded-md border px-3 py-2"
            placeholder="University slug (ex: ucsd / ucsb / uci)"
            value={universitySlug}
            onChange={(e) => setUniversitySlug(e.target.value)}
            required
          />
        )}

        <button className="w-full rounded-md bg-black py-2 text-white">
          Create account
        </button>
      </form>
    </div>
  );
}
