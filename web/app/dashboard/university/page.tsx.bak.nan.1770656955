"use client";

import * as React from "react";
import { authFetch } from "@/lib/authFetch";

type RequirementKind = "REQUIRED" | "INFO";
type RequirementPriority = "LOW" | "MEDIUM" | "HIGH";
type StayMode = "SHORT" | "LONG" | "ANY";

type UniReq = {
  id: string;
  universityId: string;
  title: string;
  description?: string | null;
  kind: RequirementKind;
  priority: RequirementPriority;
  stayMode: StayMode;
  dueDate?: string | null;
  dueDaysBefore?: number | null;
  ctaLabel?: string | null;
  ctaUrl?: string | null;
  createdAt: string;
  updatedAt: string;
};

async function listReqs(): Promise<UniReq[]> {
  const r = await authFetch("/api/v1/university/requirements", { method: "GET" });
  const data = r.data ?? [];
  if (!r.res.ok) throw new Error((data as any)?.message ?? "Failed to load requirements");
  return data as UniReq[];
}

async function createReq(payload: {
  title: string;
  description?: string;
  kind?: RequirementKind;
  priority?: RequirementPriority;
  stayMode?: StayMode;
  dueDate?: string;
  dueDaysBefore?: number;
  ctaLabel?: string;
  ctaUrl?: string;
}): Promise<UniReq> {
  const r = await authFetch("/api/v1/university/requirements", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(payload),
  });
  const data = r.data ?? {};
  if (!r.res.ok) throw new Error((data as any)?.message ?? "Failed to create requirement");
  return data as UniReq;
}

async function deleteReq(id: string) {
  const r = await authFetch(`/api/v1/university/requirements/${id}`, { method: "DELETE" });
  const data = r.data ?? {};
  if (!r.res.ok) throw new Error((data as any)?.message ?? "Failed to delete requirement");
  return data;
}

function fmtDate(iso?: string | null) {
  if (!iso) return "—";
  const d = new Date(iso);
  if (Number.isNaN(d.getTime())) return iso;
  return d.toLocaleDateString();
}

export default function UniversityDashboardPage() {
  const [items, setItems] = React.useState<UniReq[]>([]);
  const [loading, setLoading] = React.useState(true);
  const [error, setError] = React.useState<string | null>(null);

  // form
  const [title, setTitle] = React.useState("");
  const [description, setDescription] = React.useState("");
  const [kind, setKind] = React.useState<RequirementKind>("REQUIRED");
  const [priority, setPriority] = React.useState<RequirementPriority>("MEDIUM");
  const [stayMode, setStayMode] = React.useState<StayMode>("ANY");
  const [dueDaysBefore, setDueDaysBefore] = React.useState<string>("");
  const [ctaLabel, setCtaLabel] = React.useState("");
  const [ctaUrl, setCtaUrl] = React.useState("");

  async function refresh() {
    setError(null);
    setLoading(true);
    try {
      const x = await listReqs();
      setItems(x);
    } catch (e: any) {
      setError(e?.message ?? "Erreur");
    } finally {
      setLoading(false);
    }
  }

  React.useEffect(() => {
    refresh();
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, []);

  async function onCreate(e: React.FormEvent) {
    e.preventDefault();
    setError(null);

    try {
      const t = title.trim();
      if (!t) throw new Error("Title is required");

      const n = dueDaysBefore.trim() ? Number(dueDaysBefore.trim()) : undefined;
      if (dueDaysBefore.trim() && (Number.isNaN(n) || n < 0)) {
        throw new Error("dueDaysBefore must be a positive number");
      }

      await createReq({
        title: t,
        description: description.trim() ? description.trim() : undefined,
        kind,
        priority,
        stayMode,
        dueDaysBefore: n,
        ctaLabel: ctaLabel.trim() ? ctaLabel.trim() : undefined,
        ctaUrl: ctaUrl.trim() ? ctaUrl.trim() : undefined,
      });

      // reset
      setTitle("");
      setDescription("");
      setKind("REQUIRED");
      setPriority("MEDIUM");
      setStayMode("ANY");
      setDueDaysBefore("");
      setCtaLabel("");
      setCtaUrl("");

      await refresh();
    } catch (e: any) {
      setError(e?.message ?? "Erreur");
    }
  }

  async function onDelete(id: string) {
    setError(null);
    try {
      await deleteReq(id);
      setItems((prev) => prev.filter((x) => x.id !== id));
    } catch (e: any) {
      setError(e?.message ?? "Erreur");
    }
  }

  return (
    <div className="p-6 space-y-6">
      <div>
        <h1 className="text-2xl font-semibold">University Dashboard</h1>
        <p className="text-sm opacity-70">
          Manage your university requirements (these appear in the student checklist).
        </p>
      </div>

      {error && (
        <div className="text-sm text-red-600 border border-red-200 bg-red-50 rounded-lg p-3">
          {error}
        </div>
      )}

      <div className="border rounded-xl p-4 space-y-4">
        <div className="flex items-center justify-between gap-3">
          <h2 className="font-semibold">Create a requirement</h2>
          <button className="text-sm underline opacity-80" onClick={refresh} disabled={loading}>
            Refresh
          </button>
        </div>

        <form onSubmit={onCreate} className="grid grid-cols-1 md:grid-cols-2 gap-3">
          <div className="space-y-1 md:col-span-2">
            <label className="text-sm font-medium">Title</label>
            <input
              className="w-full border rounded-lg p-2"
              value={title}
              onChange={(e) => setTitle(e.target.value)}
              placeholder="Upload proof of health insurance"
            />
          </div>

          <div className="space-y-1 md:col-span-2">
            <label className="text-sm font-medium">Description</label>
            <textarea
              className="w-full border rounded-lg p-2 min-h-[80px]"
              value={description}
              onChange={(e) => setDescription(e.target.value)}
              placeholder="Optional details"
            />
          </div>

          <div className="space-y-1">
            <label className="text-sm font-medium">Kind</label>
            <select className="w-full border rounded-lg p-2" value={kind} onChange={(e) => setKind(e.target.value as RequirementKind)}>
              <option value="REQUIRED">REQUIRED</option>
              <option value="INFO">INFO</option>
            </select>
          </div>

          <div className="space-y-1">
            <label className="text-sm font-medium">Priority</label>
            <select className="w-full border rounded-lg p-2" value={priority} onChange={(e) => setPriority(e.target.value as RequirementPriority)}>
              <option value="LOW">LOW</option>
              <option value="MEDIUM">MEDIUM</option>
              <option value="HIGH">HIGH</option>
            </select>
          </div>

          <div className="space-y-1">
            <label className="text-sm font-medium">Stay mode</label>
            <select className="w-full border rounded-lg p-2" value={stayMode} onChange={(e) => setStayMode(e.target.value as StayMode)}>
              <option value="ANY">ANY</option>
              <option value="SHORT">SHORT</option>
              <option value="LONG">LONG</option>
            </select>
          </div>

          <div className="space-y-1">
            <label className="text-sm font-medium">Due days before</label>
            <input
              className="w-full border rounded-lg p-2"
              value={dueDaysBefore}
              onChange={(e) => setDueDaysBefore(e.target.value)}
              placeholder="e.g. 14"
              inputMode="numeric"
            />
          </div>

          <div className="space-y-1">
            <label className="text-sm font-medium">CTA label</label>
            <input
              className="w-full border rounded-lg p-2"
              value={ctaLabel}
              onChange={(e) => setCtaLabel(e.target.value)}
              placeholder="International office"
            />
          </div>

          <div className="space-y-1">
            <label className="text-sm font-medium">CTA url</label>
            <input
              className="w-full border rounded-lg p-2"
              value={ctaUrl}
              onChange={(e) => setCtaUrl(e.target.value)}
              placeholder="https://www.ucsd.edu/"
            />
          </div>

          <div className="md:col-span-2">
            <button className="border rounded-lg px-4 py-2 bg-black text-white">
              Create
            </button>
          </div>
        </form>
      </div>

      <div className="border rounded-xl p-4 space-y-3">
        <h2 className="font-semibold">Current requirements</h2>

        {loading ? (
          <div className="text-sm opacity-70">Loading…</div>
        ) : items.length === 0 ? (
          <div className="text-sm opacity-70">No requirements yet.</div>
        ) : (
          <div className="space-y-2">
            {items.map((x) => (
              <div key={x.id} className="border rounded-lg p-3 flex items-start justify-between gap-4">
                <div className="min-w-0 space-y-1">
                  <div className="font-medium">{x.title}</div>
                  <div className="text-xs opacity-70">
                    {x.kind} · {x.priority} · {x.stayMode} · dueDate {fmtDate(x.dueDate)} · dueDaysBefore {x.dueDaysBefore ?? "—"}
                  </div>
                  {x.description && <div className="text-sm opacity-80">{x.description}</div>}
                  {(x.ctaLabel || x.ctaUrl) && (
                    <div className="text-xs opacity-80">
                      CTA: {x.ctaLabel ?? "—"} {x.ctaUrl ? <span className="opacity-70">({x.ctaUrl})</span> : null}
                    </div>
                  )}
                </div>

                <button
                  className="text-sm border rounded-lg px-3 py-1"
                  onClick={() => onDelete(x.id)}
                >
                  Delete
                </button>
              </div>
            ))}
          </div>
        )}
      </div>
    </div>
  );
}
