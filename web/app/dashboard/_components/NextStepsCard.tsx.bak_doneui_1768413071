"use client";

import { iso2ToTravelDestination } from "@/lib/travelDestination";
import { useEffect, useMemo, useState } from "react";
import { Dialog, DialogContent, DialogHeader, DialogTitle, DialogDescription, DialogFooter } from "@/components/ui/dialog";

type EntryResult =
  | { destination: "SCHENGEN"; status: "FREE"; basedOn: string; message: string }
  | {
      destination: "SCHENGEN";
      status: "VISA_FREE";
      basedOn: string;
      maxStayDays: number;
      periodDays: number;
      etiasRequired: boolean;
      message: string;
    }
  | { destination: "SCHENGEN"; status: "VISA_REQUIRED"; basedOn: string; message: string }
  | {
      destination: "UK" | "USA" | "CANADA";
      status: "AUTH_REQUIRED" | "VISA_REQUIRED" | "FREE" | "VISA_FREE";
      basedOn: string;
      message: string;
      meta?: Record<string, any>;
    };

type NextStep = {
  title: string;
  detail: string;
  urgency: "LOW" | "MEDIUM" | "HIGH";
  createDoc?: { title: string; type: string };
  ctaLabel?: string;

};

type ChecklistItem = {
  id: string;
  title: string;
  detail: string;
  status: "DONE" | "TODO" | "INFO";
  urgency?: "LOW" | "MEDIUM" | "HIGH";
  link?: string;

  // ✅ new
  canComplete?: boolean;
  storageKey?: string;

};

function buildChecklist(args: {
  destinationIso2: string;
  passportChoice: string;
  travelResult: any | null;
  stayDays?: number;
}): ChecklistItem[] {
  const items: ChecklistItem[] = [];

  const destIso2 = (args.destinationIso2 || "").toUpperCase();
  const passport = (args.passportChoice || "BEST").toUpperCase();
  const res = args.travelResult;
  const stayDays = typeof args.stayDays === "number" ? args.stayDays : 0;
  const longStay = stayDays > 90;
  if (res?.status === "AUTH_REQUIRED") {
    const auth = res?.meta?.auth ? String(res.meta.auth) : "authorization";
    items.push({
      id: "auth",
      title: `Get your ${auth}`,
      detail: res?.message || "You need an authorization before travelling.",
      status: "TODO",
      urgency: "HIGH",
      canComplete: true,
});
  } else if (res?.status === "VISA_REQUIRED") {
    items.push({
      id: "visa",
      title: "Start your visa application",
      detail: res?.message || "A visa is required for this destination.",
      status: "TODO",
      urgency: "HIGH",
      canComplete: true,
});
  } else if (res?.status === "FREE" || res?.status === "VISA_FREE") {
    items.push({
      id: "rule",
      title: "Travel rule for short stays",
      detail: res?.message || "You can travel for short stays under the current rules.",
      status: "INFO",
      urgency: "LOW",
    });
  } else {
    items.push({
      id: "rule",
      title: "Check travel requirements",
      detail: "We could not load a clear rule. Try refreshing.",
      status: "INFO",
      urgency: "MEDIUM",
    });
  }

  if (longStay) {
    items.push({
      id: "longstay",
      title: "Long stay (90+ days)",
      detail: "For stays longer than 90 days, you usually need a long-stay visa or residence permit. Short-stay rules (ETA/ESTA/eTA) may not apply.",
      status: "INFO",
      urgency: "MEDIUM",
      canComplete: true,
});
  }

  items.push({
    id: "vault",
    title: "Store your documents",
    detail: "Add your visa/authorization/insurance documents to the vault and track expiry dates.",
    status: "INFO",
    urgency: "LOW",
    canComplete: true,
});

  return items;
}
function pillClass(u: NextStep["urgency"]) {
  switch (u) {
    case "HIGH":
      return "bg-red-100 text-red-800 border-red-200";
    case "MEDIUM":
      return "bg-yellow-100 text-yellow-800 border-yellow-200";
    case "LOW":
      return "bg-green-100 text-green-800 border-green-200";
  }
}

function computeNextStep(res: EntryResult): NextStep {
  const auth = (res as any)?.meta?.auth as string | undefined;

  if (auth === "ETA") {
    return {
      title: "Apply for a UK ETA",
      detail: "You must obtain an ETA before travelling to the UK for short visits.",
      urgency: "HIGH",
      createDoc: { title: "UK ETA", type: "eta" },
      ctaLabel: "Create ETA document",
    };
  }

  if (auth === "ESTA") {
    return {
      title: "Apply for a US ESTA",
      detail: "For short stays under the Visa Waiver Program, you need an approved ESTA before departure.",
      urgency: "HIGH",
      createDoc: { title: "US ESTA", type: "esta" },
      ctaLabel: "Create ESTA document",
    };
  }

  if (auth === "eTA") {
    return {
      title: "Apply for a Canada eTA",
      detail: "To fly to (or transit through) Canada, you need an eTA before travelling.",
      urgency: "HIGH",
      createDoc: { title: "Canada eTA", type: "eta" },
      ctaLabel: "Create eTA document",
    };
  }

  if (res.status === "FREE") {
    return {
      title: "Nothing urgent",
      detail: res.destination === "SCHENGEN"
        ? "You have free movement for short stays in Schengen."
        : "You can travel for short visits without extra authorization.",
      urgency: "LOW",
    };
  }

  if (res.status === "VISA_REQUIRED") {
    return {
      title: "Start your visa application",
      detail: "A visa appears to be required for your passport. Begin the application process as soon as possible.",
      urgency: "HIGH",
      createDoc: { title: res.destination === "SCHENGEN" ? "Schengen visa" : "Visa", type: "visa" },
      ctaLabel: "Create visa document",
    };
  }

  // SCHENGEN only: VISA_FREE can have ETIAS
  if ((res as any).destination === "SCHENGEN" && (res as any).status === "VISA_FREE") {
    if ((res as any).etiasRequired) {
      return {
        title: "Apply for ETIAS",
        detail: "You can travel visa-free for short stays, but ETIAS will be required before travel.",
        urgency: "MEDIUM",
        createDoc: { title: "ETIAS", type: "visa" },
        ctaLabel: "Create ETIAS document",
      };
    }
    return {
      title: "No additional authorization needed",
      detail: "You can travel visa-free for short stays in Schengen.",
      urgency: "LOW",
    };
  }

  return {
    title: "Check requirements",
    detail: "We couldn’t infer a single next step. Verify your travel requirements.",
    urgency: "MEDIUM",
  };
}

function isoToDateInput(iso?: string | null) {
  if (!iso) return "";
  const d = new Date(iso);
  if (Number.isNaN(d.getTime())) return "";
  return d.toISOString().slice(0, 10);
}

function suggestedExpiryDate(): string {
  // Suggest: project start date if available
  try {
    const s = localStorage.getItem("activeProjectStartDate");
    const v = isoToDateInput(s);
    if (v) return v;
  } catch {}
  return "";
}

export function NextStepsCard({
  authFetch,
  refreshKey,
  onDocumentCreated,
}: {
  authFetch: (path: string, init?: RequestInit) => Promise<Response>;
  refreshKey: number;
  onDocumentCreated?: () => void;
}) {
  const [mounted, setMounted] = useState(false);
  const checklistKey = useMemo(() => {
    if (!mounted) return "checklist:pending";
    const dest = (() => {
      try { return (localStorage.getItem("activeProjectDestinationIso2") || "").toUpperCase(); } catch { return ""; }
    })();
    const passport = (() => {
      try { return (localStorage.getItem("activeProjectPassportChoice") || "BEST").toUpperCase(); } catch { return "BEST"; }
    })();
    const purpose = (() => {
      try { return (localStorage.getItem("activeProjectPurpose") || "").toLowerCase(); } catch { return ""; }
    })();
    return `checklist:v1:${dest}:${passport}:${purpose}`;
  }, [mounted]);

  const [doneMap, setDoneMap] = useState<Record<string, boolean>>({});

  useEffect(() => {
    if (!mounted) return;
    try {
      const raw = localStorage.getItem(checklistKey);
      setDoneMap(raw ? JSON.parse(raw) : {});
    } catch {
      setDoneMap({});
    }
  }, [mounted, checklistKey]);

  function toggleDone(itemId: string) {
    setDoneMap((prev) => {
      const next = { ...prev, [itemId]: !prev[itemId] };
      try {
        localStorage.setItem(checklistKey, JSON.stringify(next));
      } catch {}
      return next;
    });
  }


  const [destIso2, setDestIso2] = useState<string>("FR");
  const [passportChoice, setPassportChoice] = useState<string>("BEST");
  const [stayDays, setStayDays] = useState<number>(0);

  useEffect(() => {
    setMounted(true);
    try {
      const d = (localStorage.getItem("activeProjectDestinationIso2") || "FR").toString().trim().toUpperCase();
      const psp = (localStorage.getItem("activePassport") || "BEST").toString().trim().toUpperCase();

      const sIso = localStorage.getItem("activeProjectStartDate");
      const eIso = localStorage.getItem("activeProjectEndDate");
      const sd = sIso ? new Date(sIso) : null;
      const ed = eIso ? new Date(eIso) : null;

      let days = 0;
      if (sd && ed && !Number.isNaN(sd.getTime()) && !Number.isNaN(ed.getTime())) {
        const diff = Math.ceil((ed.getTime() - sd.getTime()) / (1000 * 60 * 60 * 24));
        days = Number.isFinite(diff) && diff > 0 ? diff : 0;
      }

      setDestIso2(d || "FR");
      setPassportChoice(psp || "BEST");
      setStayDays(days);
    } catch {
      // ignore
    }
  }, []);

  const [data, setData] = useState<EntryResult | null>(null);

  const checklist = useMemo(() => {
    if (!mounted) return [];
    return buildChecklist({
      destinationIso2: destIso2,
      passportChoice,
      travelResult: data,
      stayDays,
    });
  }, [mounted, destIso2, passportChoice, data, stayDays]);
  const [step, setStep] = useState<NextStep | null>(null);
  const [err, setErr] = useState<string | null>(null);
  const [loading, setLoading] = useState(true);

  const [open, setOpen] = useState(false);
  const [docTitle, setDocTitle] = useState("");
  const [docExpires, setDocExpires] = useState(""); // yyyy-mm-dd
  const [creating, setCreating] = useState(false);

  const canCreate = Boolean(step?.createDoc);

  const urgencyLabel = useMemo(() => {
    if (!step) return "";
    return step.urgency === "HIGH" ? "High priority" : step.urgency === "MEDIUM" ? "Recommended" : "All good";
  }, [step]);

  useEffect(() => {
    async function load() {
      try {
        setLoading(true);
        setErr(null);

        let passportChoice = "BEST";
        try {
          passportChoice =
            (localStorage.getItem("activePassport") || "BEST").toString().trim().toUpperCase() || "BEST";
        } catch {}

        

        let destIso2 = "FR";
        try {
          destIso2 = (localStorage.getItem("activeProjectDestinationIso2") || "FR").toString().trim().toUpperCase();
        } catch {}
// Fetch active project to know the selected destination
        let destinationIso2 = "SCHENGEN";
        const res = await authFetch(
          `/api/v1/requirements/travel?destination=${iso2ToTravelDestination(destIso2)}&passport=${encodeURIComponent(passportChoice)}`
        );

        if (!res.ok) {
          const txt = await res.text();
          throw new Error(txt || `Failed (${res.status})`);
        }

        const json = (await res.json()) as EntryResult;
        setData(json);
        setStep(computeNextStep(json));
      } catch (e: any) {
        setErr(e?.message ?? "Failed to load next steps");
        setData(null);
        setStep(null);
      } finally {
        setLoading(false);
      }
    }

    load();
  }, [refreshKey, authFetch]);

  function openCreateModal() {
    if (!step?.createDoc) return;
    setDocTitle(step.createDoc.title);
    setDocExpires(suggestedExpiryDate());
    setOpen(true);
  }

  async function confirmCreate() {
    if (!step?.createDoc) return;

    if (!docExpires) {
      alert("Please set an expiration date (or a target deadline).");
      return;
    }

    setCreating(true);
    try {
      const expiresAt = new Date(docExpires + "T00:00:00.000Z").toISOString();

      const res = await authFetch("/api/v1/documents", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          title: docTitle || step.createDoc.title,
          type: step.createDoc.type,
          expiresAt,
        }),
      });

      if (!res.ok) throw new Error(await res.text());

      setOpen(false);
      onDocumentCreated?.();
    } catch (e: any) {
      alert(e?.message ?? "Failed to create document");
    } finally {
      setCreating(false);
    }
  }

  return (
    <div className="rounded-2xl border bg-white p-5">
      <div className="flex items-start justify-between gap-3">
        <div>
          <h2 className="text-lg font-semibold">What you need next</h2>
          <p className="text-sm text-gray-600">Based on your selected passport and destination rules.</p>
        </div>

        {step ? (
          <span className={"inline-flex items-center rounded-full border px-3 py-1 text-xs font-medium " + pillClass(step.urgency)}>
            {urgencyLabel}
          </span>
        ) : null}
      </div>

      {loading ? (
        <p className="mt-3 text-sm text-gray-600">Loading…</p>
      ) : err ? (
        <p className="mt-3 text-sm text-red-700">{err}</p>
      ) : !step || !data ? (
        <p className="mt-3 text-sm text-gray-600">No data.</p>
      ) : (
        <div className="mt-4 space-y-2">
          <p className="text-sm font-medium">{step.title}</p>
          <p className="text-sm text-gray-700">{step.detail}</p>

          <p className="text-xs text-gray-500">
            Based on passport: <span className="font-mono">{data.basedOn}</span>
          </p>

          {canCreate ? (
            <button
              onClick={openCreateModal}
              className="mt-3 inline-flex rounded-xl bg-black px-4 py-2 text-sm text-white hover:opacity-90 disabled:opacity-60"
            >
              {step.ctaLabel ?? "Create document"}
            </button>
          ) : null}
        </div>
      )}

      <Dialog open={open} onOpenChange={setOpen}>
        <DialogContent className="sm:max-w-[520px]">
          <DialogHeader>
            <DialogTitle>Create a document</DialogTitle>
            <DialogDescription>
              Add it to your documents list so you can track it. Choose a realistic deadline/expiry.
            </DialogDescription>
          </DialogHeader>

          <div className="mt-2 grid gap-4">
            <div>
              <label className="text-sm font-medium">Title</label>
              <input
                className="mt-1 w-full rounded-xl border px-3 py-2"
                value={docTitle}
                onChange={(e) => setDocTitle(e.target.value)}
                placeholder="ETIAS"
              />
              <p className="mt-1 text-xs text-gray-500">You can rename it (ex: “Schengen visa appointment”).</p>
            </div>

            <div>
              <label className="text-sm font-medium">Expiration / deadline</label>
              <input
                type="date"
                className="mt-1 w-full rounded-xl border px-3 py-2"
                value={docExpires}
                onChange={(e) => setDocExpires(e.target.value)}
              />
              <p className="mt-1 text-xs text-gray-500">
                Tip: we suggest your project start date if available.
              </p>
            </div>

            <div className="rounded-xl border bg-gray-50 p-3 text-sm text-gray-700">
              <p className="font-medium">Suggested info</p>
              <ul className="mt-2 list-disc pl-5 text-sm">
                <li>If you don’t know the expiry yet, use the date you must have it ready by.</li>
                <li>Later we can auto-fill based on official rules (ETIAS/visa processing times).</li>
              </ul>
            </div>
          </div>

          <DialogFooter>
            <button
              onClick={() => setOpen(false)}
              className="rounded-xl border px-4 py-2 text-sm hover:bg-gray-50"
              disabled={creating}
            >
              Cancel
            </button>
            <button
              onClick={confirmCreate}
              disabled={creating}
              className="rounded-xl bg-black px-4 py-2 text-sm text-white hover:opacity-90 disabled:opacity-60"
            >
              {creating ? "Creating…" : "Create"}
            </button>
          </DialogFooter>
        </DialogContent>
      </Dialog>
    
      
      {mounted && checklist.length > 0 && (
        <details className="mt-4 rounded-2xl border bg-white p-5">
          <summary className="cursor-pointer select-none text-sm font-medium">
            Your checklist
            <span className="ml-2 text-sm font-normal text-gray-600">(click to expand)</span>
          </summary>

          <div className="mt-4">
          <ul className="mt-4 space-y-3">
            {checklist.filter((it) => it.id !== "passport" && it.id !== "destination").map((it) => (<li key={it.id} className="rounded-xl border bg-gray-50 p-4">
                <div className="flex items-start justify-between gap-3">
                  <div>
                    <p className="font-medium">{it.title}</p>
                    <p className="mt-1 text-sm text-gray-600" suppressHydrationWarning>{it.detail}</p>
                  </div>
                </div>
              </li>
            ))}
          </ul>
        
          </div>
        </details>
      )}
</div>
  );
}
